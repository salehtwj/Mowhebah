document.addEventListener("DOMContentLoaded", function () {
    const postContainer = document.getElementById("post-container");
    const postForm = document.getElementById("post-form");
    const postText = document.getElementById("post-text");
    const postFile = document.getElementById("post-file");
    const postTypeSelect = document.getElementById("post-type");

    const fakeUsers = [
        "ÿ£ÿ≠ŸÖÿØ ÿÆÿßŸÑÿØ", "ŸÖÿ≠ŸÖÿØ ÿßŸÑÿπÿ™Ÿäÿ®Ÿä", "ŸÅÿßÿ∑ŸÖÿ© ÿßŸÑÿ≤Ÿáÿ±ÿßŸÜŸä", "ÿ≥ÿßÿ±ÿ© ÿßŸÑÿØŸàÿ≥ÿ±Ÿä", "ÿπÿ®ÿØ ÿßŸÑŸÑŸá ÿßŸÑÿ≥ÿ®ŸäÿπŸä",
        "ŸÜŸàÿ±ÿ© ÿßŸÑÿ¥ŸÖÿ±Ÿä", "ÿÆÿßŸÑÿØ ÿßŸÑŸÖÿ∑Ÿäÿ±Ÿä", "Ÿäÿßÿ≥ŸÖŸäŸÜ ÿßŸÑÿ≠ÿ±ÿ®Ÿä", "ŸÅŸäÿµŸÑ ÿßŸÑÿ¥Ÿáÿ±ÿßŸÜŸä", "ÿ±ŸäŸÖ ÿßŸÑŸÇÿ≠ÿ∑ÿßŸÜŸä"
    ];

    // const fakePosts = [
    //     { type: "regular", name: "ÿ£ÿ≠ŸÖÿØ ÿÆÿßŸÑÿØ", text: "üéâ ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ÿßŸÑÿ¨ŸÖŸäÿπ! ÿ£ŸÜÿß ŸÖÿ™ÿ≠ŸÖÿ≥ ŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ•ŸÜÿ¨ÿßÿ≤Ÿä ÿßŸÑÿ¨ÿØŸäÿØ ÿßŸÑŸäŸàŸÖ.", image: "", time: "2025-04-08 10:30" },
    //     { type: "regular", name: "ŸÖÿ≠ŸÖÿØ ÿßŸÑÿπÿ™Ÿäÿ®Ÿä", text: "üí™ ÿßÿ≥ÿ™ŸÖÿ±Ÿàÿß ŸÅŸä ÿßŸÑÿ™ÿØÿ±Ÿäÿ® ŸàÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ¨ÿßÿØ ŸÑÿ™ÿ≠ŸÇŸäŸÇ ÿ£ŸáÿØÿßŸÅŸÉŸÖ!", image: "https://source.unsplash.com/600x400/?training", time: "2025-04-07 15:45" },
    //     { type: "challenge", name: "ÿ≥ÿßÿ±ÿ© ÿßŸÑÿØŸàÿ≥ÿ±Ÿä", text: "ÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖ: ŸáŸÑ ŸäŸèŸÖŸÉŸÜŸÉ ÿ±ŸÉŸÑ ÿßŸÑŸÉÿ±ÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸáÿØŸÅ ÿ¨ŸÖŸäŸÑÿü ÿ¥ÿßÿ±ŸÉŸàÿß ŸÅŸäÿØŸäŸàŸáÿßÿ™ŸÉŸÖ! ‚öΩü•Ö", image: "https://source.unsplash.com/600x400/?soccer", time: "2025-04-06 09:15" },
    //     { type: "regular", name: "ŸÅÿßÿ∑ŸÖÿ© ÿßŸÑÿ≤Ÿáÿ±ÿßŸÜŸä", text: "üî• ÿ¥ÿßŸáÿØŸàÿß Ÿáÿ∞ÿß ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑÿ™ÿ≠ŸÅŸäÿ≤Ÿä ŸÑŸÖŸàŸáÿ®ÿ© ÿ±ÿßÿ¶ÿπÿ© ŸÅŸä ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ!", video: "https://www.w3schools.com/html/mov_bbb.mp4", time: "2025-04-05 14:20" },
    //     { type: "challenge", name: "ÿ≥ÿßÿ±ÿ© ÿßŸÑÿØŸàÿ≥ÿ±Ÿä", text: "ÿ™ÿ≠ÿØŸä ÿ¨ÿØŸäÿØ: ŸÖŸÜ Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑŸÖÿ±ÿßŸàÿ∫ÿ© ÿ®ÿ£ŸÅÿ∂ŸÑ ÿ∑ÿ±ŸäŸÇÿ©ÿü ÿ£ÿ±ŸàŸÜÿß ŸÖŸáÿßÿ±ÿßÿ™ŸÉŸÖ! üéØ", image: "https://source.unsplash.com/600x400/?football", time: "2025-04-04 11:10" }
    // ];

    const fakePosts = [
        {
            type: "regular",
            name: "ÿ≤ŸäÿßÿØ",
            text: "üî• Ÿáÿ∞ÿß ÿßŸÑŸÅŸäÿØŸäŸà ŸäŸàÿ∂ÿ≠ ŸÉŸäŸÅ ŸäŸÖŸÉŸÜ ŸÑŸÑÿ™ÿ≠ŸÅŸäÿ≤ ŸàÿßŸÑŸÖÿ´ÿßÿ®ÿ±ÿ© ÿ£ŸÜ ÿ™ÿµŸÜÿπ ŸÖŸÜŸÉ ÿ®ÿ∑ŸÑÿßŸã ŸÅŸä ÿßŸÑÿ™ŸÜÿ≥. ÿ¥ÿßŸáÿØŸàÿß ŸÉŸäŸÅ ŸÇŸÑÿ® ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ŸÑÿµÿßŸÑÿ≠Ÿá!",
            video: "https://youtube/hkHnqrDZPpI?si=eXxcrAQU4LKTffj7",
            time: "2025-04-09 10:00"
        },
        {
            type: "challenge",
            name: "ÿ¨ŸàÿØ ",
            text: "ÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖ: ŸáŸÑ ŸäŸèŸÖŸÉŸÜŸÉ ÿ±ŸÉŸÑ ÿßŸÑŸÉÿ±ÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸáÿØŸÅ ÿ¨ŸÖŸäŸÑÿü ÿ¥ÿßÿ±ŸÉŸàÿß ŸÅŸäÿØŸäŸàŸáÿßÿ™ŸÉŸÖ! ‚öΩü•Ö",
            video: "",
            time: "2025-04-08 17:25"
        },
        {
            type: "regular",
            name: "ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ",
            text: "‚öΩ ÿ¥ÿßŸáÿØŸàÿß Ÿáÿ∞ÿß ÿßŸÑŸáÿØŸÅ ÿßŸÑÿ£ÿ≥ÿ∑Ÿàÿ±Ÿä ŸÖŸÜ ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÖŸÑÿπÿ®! ÿßŸÑÿ•ÿ®ÿØÿßÿπ ŸÖŸÖŸÉŸÜ ŸÑŸÖÿß ÿ™ÿ´ŸÇ ŸÅŸä ŸÖŸáÿßÿ±ÿßÿ™ŸÉ Ÿàÿ™ÿ∫ÿßŸÖÿ±!",
            video: "https://www.youtube.com/watch?v=MF2Qp0HG0ow",
            time: "2025-04-08 13:15"
        },
        {
            type: "challenge",
            name: "ŸÜŸàÿ±ÿ© ",
            text: "üí™ ÿ™ÿ≠ÿØŸä ÿßŸÑŸÇŸàÿ© ŸàÿßŸÑÿ™ÿ≠ŸÖŸÑ! ÿ¥ÿßŸáÿØŸàÿß Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑŸÖŸÉÿ´ŸÅ Ÿàÿ¨ÿ±ÿ®Ÿàÿß ŸÖÿ´ŸÑŸá. ŸÖŸäŸÜ ŸäŸÇÿØÿ± ŸäŸÉŸÖŸÑŸá ŸÑŸÑŸÜŸáÿßŸäÿ©ÿü",
            video: "https://www.youtube.com/watch?v=S7X8NDyR7i0",
            time: "2025-04-07 19:00"
        },
        {
            type: "regular",
            name: "ŸÅŸäÿµŸÑ ",
            text: "ŸÑŸÇÿ∑ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ© ŸÑŸÑÿßÿπÿ®ŸäŸÜ ŸàŸáŸÖ Ÿäÿ≥ÿ¨ŸÑŸàŸÜ ŸÖŸÜ ÿ≤ŸàÿßŸäÿß ŸÖÿ≥ÿ™ÿ≠ŸäŸÑÿ©! Ÿáÿ∞ÿß ŸáŸà ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿä ÿßŸÑÿ≠ŸÇŸäŸÇŸä!",
            video: "https://www.youtube.com/watch?v=29vmcEnAWTI",
            time: "2025-04-07 11:40"
        }
    ];
    
    fakePosts.forEach(post => {
        addPost(post.type, post.text, post.image || post.video, post.name, post.time);
    });

    postForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const text = postText.value.trim();
        const file = postFile.files[0];
        const postType = postTypeSelect.value;

        if (!text && !file) {
            alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÜÿµ ÿ£Ÿà ÿ±ŸÅÿπ ŸÖŸÑŸÅ!");
            return;
        }

        let mediaSrc = "";
        if (file) {
            mediaSrc = URL.createObjectURL(file);
        }

        const now = new Date();
        const time = now.toLocaleString("ar-SA", { hour12: false });

        const username = postType === "challenge" ? "ÿµÿßŸÑÿ≠ ÿßŸÑÿ™ŸàŸäÿ¨ÿ±Ÿä" : fakeUsers[Math.floor(Math.random() * fakeUsers.length)];
        
        addPost(postType, text, mediaSrc, username, time);

        postForm.reset();
        $("#postModal").modal("hide");
    });

    // Function to analyze the video with challenge context
    function analyzeVideo(videoFile, challengeText) {
        const formData = new FormData();
        formData.append('video', videoFile);
        formData.append('challenge', challengeText);
        
        return fetch('/analyze_video', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        });
    }

    // Enhanced function to show the analysis result in a popup with chart
    function showAnalysisPopup(result) {
        // Parse the result if it's a string
        let data;
        
        try {
            // Handle if result is already a parsed object or still a string
            if (typeof result === 'string') {
                data = JSON.parse(result);
            } else {
                data = result;
            }
        } catch (error) {
            // If parsing fails, treat as raw text
            data = { rating: 0, description: result };
        }
        
        // Create the modal backdrop
        const modalBackdrop = document.createElement('div');
        modalBackdrop.classList.add('modal-backdrop', 'fade', 'show');
        modalBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        document.body.appendChild(modalBackdrop);
        
        // Create the modal HTML with chart container
        const modalHTML = `
            <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog" dir="rtl">
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <div class="modal-header" style="border-bottom: none; padding: 15px 20px;">
                            <h5 class="modal-title" style="color: #8900ce; font-weight: bold;">ŸÜÿ™Ÿäÿ¨ÿ© ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="font-size: 24px; color: #8900ce;">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body text-center" style="padding: 20px;">
                            <div class="chart-container my-3" style="position: relative; height:220px; width:100%">
                                <canvas id="analysisChart"></canvas>
                            </div>
                            <div class="result-value text-center my-2" style="font-size: 24px; font-weight: bold;">
                                ${data.rating}%
                            </div>
                            <div class="result-description mt-3 p-3" style="color: #333; font-size: 16px; text-align: center;">
                                ${data.description || 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸàÿµŸÅ ŸÖÿ™ÿßÿ≠'}
                            </div>
                        </div>
                        <div class="modal-footer" style="border-top: none; justify-content: center; padding-bottom: 20px;">
                            <button type="button" class="btn" data-dismiss="modal" style="background-color: #6c757d; color: white; min-width: 80px; border-radius: 5px;">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add the modal to the DOM
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        
        // Add event listeners to close buttons
        const closeButtons = modalContainer.querySelectorAll('[data-dismiss="modal"]');
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                document.body.removeChild(modalContainer);
                document.body.removeChild(modalBackdrop);
            });
        });
        
        // Also close on backdrop click
        modalBackdrop.addEventListener('click', () => {
            document.body.removeChild(modalContainer);
            document.body.removeChild(modalBackdrop);
        });

        // Create the chart after the modal is added to the DOM
        setTimeout(() => {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            
            // Create a gauge chart
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [data.rating, 100 - data.rating],
                        backgroundColor: [
                            // Use a more vibrant purple color similar to your screenshot
                            '#8900ce', 
                            '#e0e0e0'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '75%',
                    rotation: -90,
                    circumference: 180,
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: function(chart) {
                        // No text drawn in the center by the plugin
                        // We'll use a separate div for this as seen in your screenshot
                    }
                }]
            });
        }, 100); // Short delay to ensure DOM elements are ready
    }

    function addPost(type, text, media, username, time) {
        const post = document.createElement("div");
        post.classList.add("card", "card-body", "mb-3");
        
        if (type === "challenge") {
            post.classList.add("challenge-post");
        }

        let mediaHTML = "";
    if (media) {
        if (media.includes("youtube.com/watch?v=")) {
            // Extract YouTube video ID
            const videoId = media.split("v=")[1].split("&")[0];
            mediaHTML = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else if (typeof media === "string" && media.endsWith(".mp4")) {
            mediaHTML = `<video controls src="${media}" class="w-100 mt-2"></video>`;
        } else {
            mediaHTML = `<img src="${media}" class="w-100 mt-2" alt="" />`;
        }
    }

        let responseButtonHTML = "";
        if (type === "challenge") {
            responseButtonHTML = `
                <div class="mt-3">
                    <button class="btn btn-primary response-btn" style="background-color: #8900ce; border-color: #8900ce;">
                        <i class="fas fa-upload"></i> ÿ±ŸÅÿπ ŸÅŸäÿØŸäŸà ŸÑŸÑÿ™ÿ≠ÿØŸä
                    </button>
                    <input type="file" class="d-none challenge-response" accept="video/*">
                </div>
                <div class="challenge-responses mt-3"></div>
            `;
        }

        post.innerHTML = `
            <div class="row">
                <div class="col-md-2">
                    <img class="rounded-circle d-none d-md-block" src="https://www.gravatar.com/avatar/anything?s=200&d=mm" alt="ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ"/>
                    <p class="text-center">${username}</p>
                    <p class="text-muted text-center" style="font-size: 12px;">${time}</p>
                </div>
                <div class="col-md-10">
                    ${type === "challenge" ? '<span class="badge badge-warning mb-2" style="background-color: #8900ce;">ÿ™ÿ≠ÿØŸä</span>' : ''}
                    <p class="lead">${text}</p>
                    ${mediaHTML}
                    ${responseButtonHTML}
                </div>
            </div>
        `;

        const responseBtn = post.querySelector(".response-btn");
        if (responseBtn) {
            responseBtn.addEventListener("click", function() {
                const fileInput = this.nextElementSibling;
                fileInput.click();
            });
            
            const fileInput = post.querySelector(".challenge-response");
            fileInput.addEventListener("change", function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const videoURL = URL.createObjectURL(file);
                    
                    // Get the challenge text from the post
                    const challengeText = post.querySelector(".lead").textContent;
                    
                    // First add the response to the UI
                    const responseContainer = post.querySelector(".challenge-responses");
                    const response = document.createElement("div");
                    response.classList.add("challenge-response-item", "mt-3", "p-3", "border", "rounded");
                    
                    const randomUser = fakeUsers[Math.floor(Math.random() * fakeUsers.length)];
                    const now = new Date();
                    const responseTime = now.toLocaleString("ar-SA", { hour12: false });
                    
                    response.innerHTML = `
                        <div class="d-flex align-items-center mb-2">
                            <img class="rounded-circle mr-2" src="https://www.gravatar.com/avatar/anything?s=50&d=mm" style="width: 30px; height: 30px;" alt="ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" />
                            <span class="font-weight-bold">${randomUser}</span>
                            <small class="text-muted mr-2">${responseTime}</small>
                        </div>
                        <video controls src="${videoURL}" class="w-100"></video>
                        <div class="analysis-status mt-2 text-center">
                            <div class="spinner-border" style="color: #8900ce;" role="status">
                                <span class="sr-only">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...</span>
                            </div>
                            <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà...</p>
                        </div>
                    `;
                    
                    responseContainer.appendChild(response);
                    
                    // Then analyze the video with challenge context
                    analyzeVideo(file, challengeText)
                        .then(data => {
                            // Update the status indicator
                            const analysisStatus = response.querySelector('.analysis-status');
                            if (analysisStatus) {
                                analysisStatus.innerHTML = `
                                    <p class="text-success">ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úì</p>
                                    <button class="btn btn-sm mt-2" style="background-color: #8900ce; color: white; border-radius: 5px;">
                                        <i class="fas fa-chart-bar"></i> ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
                                    </button>
                                `;

                                // Add event listener to the "View Result" button
                                const viewResultBtn = analysisStatus.querySelector('button');
                                viewResultBtn.addEventListener('click', () => {
                                    showAnalysisPopup(data.result);
                                });
                            }
                            
                            // Show the analysis result immediately
                            if (data.result) {
                                showAnalysisPopup(data.result);
                            } else if (data.error) {
                                showAnalysisPopup({ rating: 0, description: "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà: " + data.error });
                            }
                        })
                        .catch(error => {
                            console.error("Error analyzing video:", error);
                            
                            // Update the status indicator
                            const analysisStatus = response.querySelector('.analysis-status');
                            if (analysisStatus) {
                                analysisStatus.innerHTML = '<p class="text-danger">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà</p>';
                            }
                            
                            showAnalysisPopup({ rating: 0, description: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà" });
                        });
                }
            });
        }

        postContainer.prepend(post);
    }
});